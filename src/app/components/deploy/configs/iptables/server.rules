# start filters
*filter

-A INPUT -i lo -j ACCEPT
-A INPUT ! -i lo -d 127.0.0.0/8 -j REJECT

-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

-A OUTPUT -j ACCEPT

# open component ports

{% if 'redis' in CURRENT_HOST_COMPONENTS %}
# accept from app ips
{% for _, host in HOSTS_BY_COMPONENT['app'] %}
-A INPUT -p tcp -s {{ host['private'] }} --dport {{ SETTINGS['redis']['port'] }} -j ACCEPT
{% endfor %}
{% endif %}

{% if 'nginx' in CURRENT_HOST_COMPONENTS %}
# accept for http and https
-A INPUT -p tcp --dport 80 -j ACCEPT
-A INPUT -p tcp --dport 443 -j ACCEPT
{% endif %}

{% if 'app' in CURRENT_HOST_COMPONENTS %}
# accept from nginx connections [you can change port range]
{% for _, host in HOSTS_BY_COMPONENT['nginx'] %}
-A INPUT -p tcp -s {{ host['private'] }} --dport {{ port }}:{{ port + 1000 }} -j ACCEPT
{% endfor %}
{% endif %}

# end open ports

-A INPUT -p tcp -m state --state NEW --dport 22 -j ACCEPT
-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT

# not works on orange pi ubuntu [iptables to old may be?]
# -A INPUT -m limit --limit 5/min -j LOG --log-prefix "iptables redis denied: " --log-level 7

-A INPUT -j REJECT
-A FORWARD -j REJECT

COMMIT
# end filters [need for templated end file]
